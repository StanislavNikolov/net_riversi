<!DOCTYPE html>
<html>
	<head>
		<style>
			#board td {
				width: 2.5rem;
				height: 2.5rem;
				padding: 0;
				text-align: center;
				background-color: blanchedalmond;
			}
			#board .cellid {
				font-size: 0.5rem;
			}
			.player-0::before {
				content: "⚪";
			}
			.player-1::before {
				content: "⚫";
			}
			.info::before {
				content: "ℹ️";
			}
			.selected {
				background-color: aqua;
			}

			body {
				display: flex;
				flex-direction: row;
			}
			.pane {
				width: 50%;
				margin: 0;
				overflow-y: scroll;
				height: 100vh;
			}
		</style>
	</head>

	<body>
		<div class="pane left">
			<h1> <a href="/">⬅️ Go back to the list </a> </h1>
			<span id="player-0" class="player-0"></span> vs. <span id="player-1" class="player-1"></span>
			<div id="started"></div>
			<div id="board"></div>
			Score: <span id="score"></span>
		</div>
		<div class="pane right">
			<div id="events"></div>
		</div>

		<script>
			const fmtDate = str => {
				const date = new Date(str);
				const month = String(date.getMonth()+1).padStart(2, '0');
				const day = String(date.getDate()).padStart(2, '0');
				return `${date.getHours()}:${date.getMinutes()}:${date.getSeconds()} ${date.getFullYear()}-${month}-${day}`;
			}

			const renderBoard = board => {
				let renderedBoard = '';

				renderedBoard += '<table>';
				let cellId = 0;
				for(let row of board) {
					renderedBoard += '<tr>'
					for(const square of row) {
						renderedBoard += `
						<td class="player-${square}"">
							<span class="cellid">${cellId ++}</span>
						</td>
						`;
					}
					renderedBoard += '</tr>';
				}
				renderedBoard += '</table>';

				return renderedBoard;
			};

			const renderEvents = events => {
				if(events == null) {
					return '';
				}

				let output = '';
				for(const idx in events) {
					const ev = events[idx];
					let className = ev.player === 255 ? 'info' : `player-${ev.player}`;

					output += `<div id="event#${idx}" class="${className}">${ev.message}</div>`;
				}
				return output;
			};

			const viewEvent = evIdx => {
				document.getElementById('board').innerHTML = renderBoard(game.events[evIdx].currentBoard.squares);

				// Unmark other events as selected.
				for(const evEl of document.getElementById('events').childNodes) {
					evEl.classList.remove('selected');
				}

				// Make this one selected.
				document.getElementById(`event#${evIdx}`).classList.add('selected');

				document.getElementById('score').innerText = game.events[evIdx].score;
			}

			const gameId = (new URLSearchParams(window.location.search)).get('id');
			let game = {events: []};

			fetch(`/api/events/${gameId}`)
			.then(resp => resp.json())
			.then(events => {
				game.events = events;

				document.getElementById('events').innerHTML = renderEvents(game.events);

				viewEvent(game.events.length-1);
			});

			fetch(`/api/game/${gameId}`)
			.then(resp => resp.json())
			.then(_game => {
				console.log(_game)
				Object.assign(game, _game);

				document.getElementById('player-0').innerText = game.player0;
				document.getElementById('player-1').innerText = game.player1;
				document.getElementById('started').innerText = fmtDate(game.startedAt);
			});

			document.getElementById('events').addEventListener('mouseover', ev => {
				const eventEl = ev.target;
				if (!eventEl.id.startsWith('event#')) {
					return;
				}

				viewEvent(eventEl.id.substr( "event#".length ))
			});
		</script>
	</body>
</html>